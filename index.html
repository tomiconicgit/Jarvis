<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"
  />
  <title>Iconic Editor — Gizmo Visible Fix</title>
  <meta name="theme-color" content="#0b0b0b" />

  <!-- Module shim + import map -->
  <script src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>

  <style>
    :root { --bg:#0b0b0b; --panel:#141414; --line:#222; --text:#ddd; --muted:#999; --accent:#49a6ff; }
    html, body { height:100%; width:100%; margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

    /* Layout: top viewer, bottom UI panel (mobile-first) */
    #app {
      position:fixed; inset:0; display:grid;
      grid-template-rows: 60% 40%;
    }
    #viewer {
      position:relative; background:#0b0b0b; border-bottom:1px solid var(--line);
    }
    #canvas-container { position:absolute; inset:0; }
    #canvas-container canvas { display:block; width:100%; height:100%; touch-action:none; }
    .axes-note { position:absolute; right:10px; bottom:10px; font-size:12px; color:var(--muted); opacity:.7 }
    .status { position:absolute; left:10px; bottom:10px; font-size:12px; color:var(--muted); opacity:.8 }

    /* Bottom panel */
    #panel {
      position:relative; background:var(--panel);
      display:grid; grid-template-rows:auto 1fr;
    }
    .toolbar {
      display:flex; gap:8px; padding:8px; border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, #171717, #131313);
      position:relative; z-index:2;
    }
    .toolbar .group { display:flex; gap:6px; }
    .toolbar button {
      border:1px solid var(--line); background:#1a1a1a; color:var(--text); padding:6px 10px; border-radius:8px; font-size:13px;
    }
    .toolbar button:hover { border-color:#2a2a2a; }
    .toolbar .split { flex:1 }
    .toolbar .badge { font-size:11px; color:var(--muted); margin-left:6px; }

    /* Panels area */
    .panes { position:relative; overflow:auto; }
    .pane {
      padding:12px; display:none;
    }
    .pane.active { display:block; }

    /* Simple lists */
    .list { display:grid; gap:8px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; background:#161616; border:1px solid var(--line); border-radius:8px; }
    .row label { font-size:13px; color:#ccc; }
    .row input[type="range"] { width:50%; }
    .hint { color:var(--muted); font-size:12px; }

    /* Desktop: put panel at right for wide screens */
    @media (min-width: 900px) {
      #app { grid-template-rows: 100%; grid-template-columns: 70% 30%; }
      #viewer { border-bottom:0; border-right:1px solid var(--line); }
      #panel { grid-row:1; grid-column:2; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="viewer">
      <div id="canvas-container"></div>
      <div class="axes-note">Gizmo axes: X red • Y green • Z blue</div>
      <div class="status" id="status">No selection</div>

      <!-- Quick transform buttons overlay -->
      <div class="toolbar" style="position:absolute; left:10px; top:10px; right:auto;">
        <div class="group">
          <button data-tmode="translate" title="W">Move</button>
          <button data-tmode="rotate"    title="E">Rotate</button>
          <button data-tmode="scale"     title="R">Scale</button>
        </div>
        <div class="group">
          <button data-tspace="world" title="1">World</button>
          <button data-tspace="local" title="2">Local</button>
        </div>
        <span class="badge">Tap object to attach gizmo</span>
      </div>
    </div>

    <div id="panel">
      <!-- Main toolbar -->
      <div class="toolbar">
        <div class="group">
          <button id="btn-add-cube">Add Cube</button>
          <button id="btn-add-sphere">Add Sphere</button>
        </div>
        <div class="group">
          <button id="btn-focus">Focus</button>
          <button id="btn-clear">Clear Selection</button>
        </div>
        <div class="split"></div>
        <div class="group">
          <button id="btn-grid-toggle">Grid On/Off</button>
          <button id="btn-axis-toggle">Axes On/Off</button>
        </div>
      </div>

      <!-- Panes -->
      <div class="panes">
        <section class="pane active" id="pane-props">
          <h3 style="margin:6px 0 12px;">Properties</h3>
          <div class="list">
            <div class="row">
              <label>Uniform Scale</label>
              <input id="ui-scale" type="range" min="0.1" max="5" step="0.01" value="1" />
            </div>
            <div class="row">
              <label>Wireframe (Active)</label>
              <input id="ui-wire" type="checkbox" />
            </div>
            <div class="row">
              <label>Gizmo Size</label>
              <input id="ui-gizmo-size" type="range" min="0.3" max="2.5" step="0.1" value="1" />
            </div>
            <p class="hint">W/E/R switch mode • 1/2 switch space • Tap mesh to attach gizmo.</p>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import {
      initScene, addModel, selectObject, clearSelection, focusSelection,
      setTransformMode, setTransformSpace, getScene, getCamera, getRenderer
    } from './main.js';

    // Boot scene
    const container = document.getElementById('canvas-container');
    initScene(container);

    // Optional helpers
    const scene = getScene();
    const status = document.getElementById('status');

    // Small axis + grid toggles
    const axesHelper = new THREE.AxesHelper(1.4); axesHelper.visible = true; scene.add(axesHelper);
    let gridRef = scene.children.find(o => o.isGridHelper); // created in scene-manager
    document.getElementById('btn-grid-toggle').onclick = () => { gridRef.visible = !gridRef.visible; };
    document.getElementById('btn-axis-toggle').onclick = () => { axesHelper.visible = !axesHelper.visible; };

    // Add sample builders (uses object-manifest.js in your project normally)
    document.getElementById('btn-add-cube').onclick = async () => {
      const { MeshStandardMaterial, BoxGeometry, Mesh } = THREE;
      const mesh = new Mesh(new BoxGeometry(1,1,1), new MeshStandardMaterial({ color: 0x7daafc, metalness:0.1, roughness:0.7 }));
      mesh.name = 'Cube';
      addModel(mesh);
      selectObject(mesh);
      status.textContent = 'Selected: Cube';
    };
    document.getElementById('btn-add-sphere').onclick = async () => {
      const { MeshStandardMaterial, SphereGeometry, Mesh } = THREE;
      const mesh = new Mesh(new SphereGeometry(0.6, 32, 16), new MeshStandardMaterial({ color: 0xffad66, metalness:0.2, roughness:0.6 }));
      mesh.name = 'Sphere';
      mesh.position.set(1.3, 0.6, 0);
      addModel(mesh);
      selectObject(mesh);
      status.textContent = 'Selected: Sphere';
    };

    document.getElementById('btn-focus').onclick = () => focusSelection();
    document.getElementById('btn-clear').onclick = () => { clearSelection(); status.textContent = 'No selection'; };

    // Simple UI bindings
    document.getElementById('ui-scale').addEventListener('input', (e) => {
      const s = parseFloat(e.target.value);
      if (window.currentSelectionRef) {
        window.currentSelectionRef.scale.setScalar(s);
      }
    });
    document.getElementById('ui-wire').addEventListener('change', (e) => {
      if (window.currentSelectionRef) {
        if (window.currentSelectionRef.material) {
          window.currentSelectionRef.material.wireframe = !!e.target.checked;
        }
      }
    });
    document.getElementById('ui-gizmo-size').addEventListener('input', (e) => {
      const v = parseFloat(e.target.value);
      // scene-manager exposes transformControls on module scope; adjust via event
      window.dispatchEvent(new CustomEvent('iconic:set-gizmo-size', { detail: v }));
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (ev) => {
      if (ev.key === 'w' || ev.key === 'W') setTransformMode('translate');
      if (ev.key === 'e' || ev.key === 'E') setTransformMode('rotate');
      if (ev.key === 'r' || ev.key === 'R') setTransformMode('scale');
      if (ev.key === '1') setTransformSpace('world');
      if (ev.key === '2') setTransformSpace('local');
    });

    // Track selection status via custom event from scene-manager
    window.addEventListener('iconic:selection-changed', (e) => {
      const obj = e.detail;
      window.currentSelectionRef = obj || null;
      status.textContent = obj ? `Selected: ${obj.name || obj.type}` : 'No selection';
      // Sync wireframe switch
      const wf = document.getElementById('ui-wire');
      wf.checked = !!(obj && obj.material && obj.material.wireframe);
    });
  </script>

  <script type="module" src="./main.js"></script>
</body>
</html>